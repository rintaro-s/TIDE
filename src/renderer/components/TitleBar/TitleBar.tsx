import React, { useCallback, useState } from 'react';
import { useTheme } from '../../contexts/ThemeContext';
import { useApp } from '../../contexts/AppContext';
import ProgressLog from '../ProgressLog/ProgressLog';
import LANShareManager from '../LANShareManager/LANShareManager';
import './TitleBar.css';

interface TitleBarProps {
  mode?: 'arduino' | 'platformio' | null;
  onNewProject?: () => void;
}

const TitleBar: React.FC<TitleBarProps> = ({ mode, onNewProject }) => {
  const { theme, toggleTheme } = useTheme();
  const { currentProject } = useApp();
  const [showProgressLog, setShowProgressLog] = useState(false);
  const [showLANShare, setShowLANShare] = useState(false);
  
  console.log('üé¨ TitleBar rendered', { mode, theme });

  const handleMenuClick = useCallback(async (menuItem: string) => {
    switch (menuItem) {
      case 'new-project':
        if (onNewProject) {
          onNewProject();
        } else {
          // Create new project dialog
          try {
            const result = await window.electronAPI?.dialog.showMessageBox({
              type: 'question',
              buttons: ['Arduino „Éó„É≠„Ç∏„Çß„ÇØ„Éà', 'PlatformIO „Éó„É≠„Ç∏„Çß„ÇØ„Éà', '„Ç≠„É£„É≥„Çª„É´'],
              defaultId: 0,
              title: 'Êñ∞Ë¶è„Éó„É≠„Ç∏„Çß„ÇØ„Éà‰ΩúÊàê',
              message: '„Å©„ÅÆÁ®ÆÈ°û„ÅÆ„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Çí‰ΩúÊàê„Åó„Åæ„Åô„ÅãÔºü'
            });
            
            if (result && result.response < 2) {
              const projectType = result.response === 0 ? 'arduino' : 'platformio';
              console.log(`Creating new ${projectType} project`);
              
              // Dispatch new project event
              const newProjectEvent = new CustomEvent('createNewProject', { 
                detail: { type: projectType } 
              });
              window.dispatchEvent(newProjectEvent);
            }
          } catch (error) {
            console.error('Failed to create new project:', error);
          }
        }
        break;
        
      case 'open-folder':
        try {
          const result = await window.electronAPI?.dialog.showOpenDialog({
            title: '„Éï„Ç©„É´„ÉÄ„ÇíÈñã„Åè',
            properties: ['openDirectory']
          });
          if (result && !result.canceled && result.filePaths.length > 0) {
            const folderPath = result.filePaths[0];
            console.log('Opening folder:', folderPath);
            
            // Dispatch folder open event
            const openFolderEvent = new CustomEvent('openFolder', { 
              detail: { path: folderPath } 
            });
            window.dispatchEvent(openFolderEvent);
            
            // Show success message
            const statusElement = document.querySelector('.status-message');
            if (statusElement) {
              statusElement.textContent = `„Éï„Ç©„É´„ÉÄ„ÇíÈñã„Åç„Åæ„Åó„Åü: ${folderPath}`;
              setTimeout(() => {
                statusElement.textContent = '';
              }, 3000);
            }
          }
        } catch (error) {
          console.error('Failed to open folder:', error);
          const statusElement = document.querySelector('.status-message');
          if (statusElement) {
            statusElement.textContent = '„Éï„Ç©„É´„ÉÄ„ÇíÈñã„Åè„ÅÆ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü';
            setTimeout(() => {
              statusElement.textContent = '';
            }, 3000);
          }
        }
        break;
        
      case 'open-file':
        try {
          const result = await window.electronAPI?.dialog.showOpenDialog({
            title: '„Éï„Ç°„Ç§„É´„ÇíÈñã„Åè',
            properties: ['openFile'],
            filters: [
              { name: 'Arduino„Éï„Ç°„Ç§„É´', extensions: ['ino', 'cpp', 'c', 'h'] },
              { name: '„Åô„Åπ„Å¶„ÅÆ„Éï„Ç°„Ç§„É´', extensions: ['*'] }
            ]
          });
          if (result && !result.canceled && result.filePaths.length > 0) {
            const filePath = result.filePaths[0];
            console.log('Opening file:', filePath);
            
            // Read file content
            const content = await window.electronAPI?.fs.readFile(filePath);
            if (content) {
              // Dispatch file open event
              const openFileEvent = new CustomEvent('openFile', { 
                detail: { path: filePath, content } 
              });
              window.dispatchEvent(openFileEvent);
            }
          }
        } catch (error) {
          console.error('Failed to open file:', error);
        }
        break;
      
      case 'save':
        // Use App.tsx handler instead of old implementation
        console.log('Save action triggered from menu');
        break;
        
      case 'save-as':
        try {
          const editorInstance = (window as any).monacoEditor;
          if (!editorInstance) {
            console.warn('No active editor');
            return;
          }
          
          const result = await window.electronAPI?.dialog.showSaveDialog({
            title: 'ÂêçÂâç„Çí‰ªò„Åë„Å¶‰øùÂ≠ò',
            defaultPath: 'untitled.ino',
            filters: [
              { name: 'Arduino„Éï„Ç°„Ç§„É´', extensions: ['ino'] },
              { name: 'C++„Éï„Ç°„Ç§„É´', extensions: ['cpp'] },
              { name: 'C„Éï„Ç°„Ç§„É´', extensions: ['c'] },
              { name: '„Éò„ÉÉ„ÉÄ„Éº„Éï„Ç°„Ç§„É´', extensions: ['h'] },
              { name: '„Åô„Åπ„Å¶„ÅÆ„Éï„Ç°„Ç§„É´', extensions: ['*'] }
            ]
          });
          
          if (result && !result.canceled && result.filePath) {
            const content = editorInstance.getValue();
            await window.electronAPI?.fs.writeFile(result.filePath, content);
            
            // Update current file reference
            (window as any).currentFile = result.filePath;
            
            // Update document title
            const fileName = result.filePath.split(/[/\\]/).pop() || 'untitled';
            document.title = `${fileName} - Tova IDE`;
            
            // Dispatch save event
            const saveEvent = new CustomEvent('fileSaved', { 
              detail: { filePath: result.filePath, content, success: true } 
            });
            window.dispatchEvent(saveEvent);
            
            console.log('‚úÖ File saved as:', result.filePath);
          }
        } catch (error) {
          console.error('Failed to save file as:', error);
        }
        break;
      
      case 'save-all':
        try {
          console.log('Saving all open files...');
          // TODO: Implement save all functionality when tabs are implemented
          
          const statusElement = document.querySelector('.status-message');
          if (statusElement) {
            statusElement.textContent = '„Åô„Åπ„Å¶„ÅÆ„Éï„Ç°„Ç§„É´„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü';
            setTimeout(() => {
              statusElement.textContent = '';
            }, 3000);
          }
        } catch (error) {
          console.error('Failed to save all:', error);
        }
        break;

      case 'undo':
        // Use Monaco editor undo if available
        const editorInstance = (window as any).monacoEditor;
        if (editorInstance) {
          editorInstance.trigger('keyboard', 'undo', null);
        } else {
          document.execCommand('undo');
        }
        break;
      
      case 'redo':
        // Use Monaco editor redo if available
        const editorInstanceRedo = (window as any).monacoEditor;
        if (editorInstanceRedo) {
          editorInstanceRedo.trigger('keyboard', 'redo', null);
        } else {
          document.execCommand('redo');
        }
        break;
      
      case 'cut':
        const editorInstanceCut = (window as any).monacoEditor;
        if (editorInstanceCut) {
          editorInstanceCut.trigger('keyboard', 'editor.action.clipboardCutAction', null);
        } else {
          document.execCommand('cut');
        }
        break;
      
      case 'copy':
        const editorInstanceCopy = (window as any).monacoEditor;
        if (editorInstanceCopy) {
          editorInstanceCopy.trigger('keyboard', 'editor.action.clipboardCopyAction', null);
        } else {
          document.execCommand('copy');
        }
        break;
      
      case 'paste':
        const editorInstancePaste = (window as any).monacoEditor;
        if (editorInstancePaste) {
          editorInstancePaste.trigger('keyboard', 'editor.action.clipboardPasteAction', null);
        } else {
          document.execCommand('paste');
        }
        break;
        
      case 'select-all':
        const editorInstanceSelectAll = (window as any).monacoEditor;
        if (editorInstanceSelectAll) {
          editorInstanceSelectAll.trigger('keyboard', 'editor.action.selectAll', null);
        } else {
          document.execCommand('selectAll');
        }
        break;
        
      case 'find':
        const editorInstanceFind = (window as any).monacoEditor;
        if (editorInstanceFind) {
          editorInstanceFind.trigger('keyboard', 'actions.find', null);
        }
        break;
        
      case 'replace':
        const editorInstanceReplace = (window as any).monacoEditor;
        if (editorInstanceReplace) {
          editorInstanceReplace.trigger('keyboard', 'editor.action.startFindReplaceAction', null);
        }
        break;

      case 'build':
        console.log('Build command triggered from menu');
        // Trigger build action
        const buildEvent = new CustomEvent('triggerBuild', { detail: { action: 'compile' } });
        window.dispatchEvent(buildEvent);
        break;
      
      case 'upload':
        console.log('Upload command triggered from menu');
        // Trigger upload action
        const uploadEvent = new CustomEvent('triggerBuild', { detail: { action: 'upload' } });
        window.dispatchEvent(uploadEvent);
        break;
      
      case 'build-upload':
        console.log('Build & upload command triggered from menu');
        // Trigger build & upload action
        const buildUploadEvent = new CustomEvent('triggerBuild', { detail: { action: 'build-upload' } });
        window.dispatchEvent(buildUploadEvent);
        break;
        
      case 'clean':
        console.log('Clean build command triggered from menu');
        const cleanEvent = new CustomEvent('triggerBuild', { detail: { action: 'clean' } });
        window.dispatchEvent(cleanEvent);
        break;
        
      case 'board-manager':
        console.log('Opening board manager');
        const boardManagerEvent = new CustomEvent('openBoardManager');
        window.dispatchEvent(boardManagerEvent);
        break;
        
      case 'library-manager':
        console.log('Opening library manager');
        const libraryManagerEvent = new CustomEvent('openLibraryManager');
        window.dispatchEvent(libraryManagerEvent);
        break;
        
      case 'serial-monitor':
        console.log('Opening serial monitor');
        // Switch to serial monitor tab in bottom panel
        const serialEvent = new CustomEvent('switchToTab', { detail: { tab: 'serial' } });
        window.dispatchEvent(serialEvent);
        break;
        
      case 'preferences':
        console.log('Opening preferences');
        const preferencesEvent = new CustomEvent('openPreferences');
        window.dispatchEvent(preferencesEvent);
        break;

      case 'about':
        try {
          await window.electronAPI?.dialog.showMessageBox({
            type: 'info',
            title: 'Tova IDE „Å´„Å§„ÅÑ„Å¶',
            message: 'Tova IDE v1.0.0',
            detail: 'Arduino „Å® PlatformIO ÈñãÁô∫„ÅÆ„Åü„ÇÅ„ÅÆÁµ±ÂêàÈñãÁô∫Áí∞Â¢É\n\nÈñãÁô∫ËÄÖ: Tova Team\n„É©„Ç§„Çª„É≥„Çπ: MIT\n\nArduino IDE „Å® PlatformIO „ÅÆÊ©üËÉΩ„ÇíÁµ±Âêà„Åó„Åü„ÄÅ\n„É¢„ÉÄ„É≥„Åß‰Ωø„ÅÑ„ÇÑ„Åô„ÅÑÈñãÁô∫Áí∞Â¢É„Åß„Åô„ÄÇ',
            buttons: ['OK']
          });
        } catch (error) {
          console.error('Failed to show about dialog:', error);
        }
        break;

      default:
        console.log('Menu item clicked:', menuItem);
        break;
    }
  }, [onNewProject, currentProject]);

  return (
    <div className="title-bar" data-surface="chrome">
      <div className="title-bar-left">
        <div className="app-icon">T</div>
        <span className="app-title">Tova IDE</span>
        <span className="mode-indicator">{mode === 'arduino' ? 'Arduino CLI' : 'PlatformIO'}</span>
      </div>

      <div className="title-bar-center">
        <div className="menu-bar">
          {/* File Menu */}
          <div className="menu-item dropdown">
            <span>„Éï„Ç°„Ç§„É´</span>
            <div className="dropdown-content">
              <div className="menu-option" onClick={() => handleMenuClick('new-project')}>
                <span>Êñ∞Ë¶è„Éó„É≠„Ç∏„Çß„ÇØ„Éà</span>
                <span className="shortcut">Ctrl+N</span>
              </div>
              <div className="menu-separator"></div>
              <div className="menu-option" onClick={() => handleMenuClick('open-file')}>
                <span>„Éï„Ç°„Ç§„É´„ÇíÈñã„Åè</span>
                <span className="shortcut">Ctrl+O</span>
              </div>
              <div className="menu-option" onClick={() => handleMenuClick('open-folder')}>
                <span>„Éï„Ç©„É´„ÉÄ„ÇíÈñã„Åè</span>
                <span className="shortcut">Ctrl+Shift+O</span>
              </div>
              <div className="menu-separator"></div>
              <div className="menu-option" onClick={() => handleMenuClick('save')}>
                <span>‰øùÂ≠ò</span>
                <span className="shortcut">Ctrl+S</span>
              </div>
              <div className="menu-option" onClick={() => handleMenuClick('save-as')}>
                <span>ÂêçÂâç„Çí‰ªò„Åë„Å¶‰øùÂ≠ò</span>
                <span className="shortcut">Ctrl+Shift+S</span>
              </div>
              <div className="menu-option" onClick={() => handleMenuClick('save-all')}>
                <span>„Åô„Åπ„Å¶‰øùÂ≠ò</span>
                <span className="shortcut">Ctrl+K Ctrl+S</span>
              </div>
              <div className="menu-separator"></div>
              <div className="menu-option" onClick={() => window.electronAPI?.window.close()}>
                <span>ÁµÇ‰∫Ü</span>
                <span className="shortcut">Ctrl+Q</span>
              </div>
            </div>
          </div>

          {/* Edit Menu */}
          <div className="menu-item dropdown">
            <span>Á∑®ÈõÜ</span>
            <div className="dropdown-content">
              <div className="menu-option" onClick={() => handleMenuClick('undo')}>
                <span>ÂÖÉ„Å´Êàª„Åô</span>
                <span className="shortcut">Ctrl+Z</span>
              </div>
              <div className="menu-option" onClick={() => handleMenuClick('redo')}>
                <span>„ÇÑ„ÇäÁõ¥„Åó</span>
                <span className="shortcut">Ctrl+Y</span>
              </div>
              <div className="menu-separator"></div>
              <div className="menu-option" onClick={() => handleMenuClick('cut')}>
                <span>Âàá„ÇäÂèñ„Çä</span>
                <span className="shortcut">Ctrl+X</span>
              </div>
              <div className="menu-option" onClick={() => handleMenuClick('copy')}>
                <span>„Ç≥„Éî„Éº</span>
                <span className="shortcut">Ctrl+C</span>
              </div>
              <div className="menu-option" onClick={() => handleMenuClick('paste')}>
                <span>Ë≤º„Çä‰ªò„Åë</span>
                <span className="shortcut">Ctrl+V</span>
              </div>
              <div className="menu-separator"></div>
              <div className="menu-option" onClick={() => handleMenuClick('select-all')}>
                <span>„Åô„Åπ„Å¶ÈÅ∏Êäû</span>
                <span className="shortcut">Ctrl+A</span>
              </div>
              <div className="menu-separator"></div>
              <div className="menu-option" onClick={() => handleMenuClick('find')}>
                <span>Ê§úÁ¥¢</span>
                <span className="shortcut">Ctrl+F</span>
              </div>
              <div className="menu-option" onClick={() => handleMenuClick('replace')}>
                <span>ÁΩÆÊèõ</span>
                <span className="shortcut">Ctrl+H</span>
              </div>
            </div>
          </div>

          {/* Build Menu */}
          <div className="menu-item dropdown">
            <span>„Éì„É´„Éâ</span>
            <div className="dropdown-content">
              <div className="menu-option" onClick={() => handleMenuClick('build')}>
                <span>„Éì„É´„Éâ</span>
                <span className="shortcut">Ctrl+B</span>
              </div>
              <div className="menu-option" onClick={() => handleMenuClick('upload')}>
                <span>„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ</span>
                <span className="shortcut">Ctrl+U</span>
              </div>
              <div className="menu-option" onClick={() => handleMenuClick('build-upload')}>
                <span>„Éì„É´„ÉâÔºÜ„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ</span>
                <span className="shortcut">Ctrl+Shift+U</span>
              </div>
              <div className="menu-separator"></div>
              <div className="menu-option" onClick={() => handleMenuClick('clean')}>
                <span>„ÇØ„É™„Éº„É≥„Éì„É´„Éâ</span>
                <span className="shortcut">Ctrl+Shift+B</span>
              </div>
            </div>
          </div>

          {/* Tools Menu */}
          <div className="menu-item dropdown">
            <span>„ÉÑ„Éº„É´</span>
            <div className="dropdown-content">
              <div className="menu-option" onClick={() => handleMenuClick('board-manager')}>
                <span>„Éú„Éº„Éâ„Éû„Éç„Éº„Ç∏„É£„Éº</span>
              </div>
              <div className="menu-option" onClick={() => handleMenuClick('library-manager')}>
                <span>„É©„Ç§„Éñ„É©„É™„Éû„Éç„Éº„Ç∏„É£„Éº</span>
              </div>
              <div className="menu-separator"></div>
              <div className="menu-option" onClick={() => handleMenuClick('serial-monitor')}>
                <span>„Ç∑„É™„Ç¢„É´„É¢„Éã„Çø„Éº</span>
                <span className="shortcut">Ctrl+Shift+M</span>
              </div>
              <div className="menu-separator"></div>
              <div className="menu-option" onClick={() => setShowProgressLog(true)}>
                <span>ÈÄ≤Êçó„É≠„Ç∞</span>
              </div>
              <div className="menu-option" onClick={() => setShowLANShare(true)}>
                <span>LANÂÜÖ„Éú„Éº„ÉâÂÖ±Êúâ</span>
              </div>
              <div className="menu-separator"></div>
              <div className="menu-option" onClick={() => handleMenuClick('preferences')}>
                <span>Ë®≠ÂÆö</span>
                <span className="shortcut">Ctrl+,</span>
              </div>
            </div>
          </div>

          {/* Help Menu */}
          <div className="menu-item dropdown">
            <span>„Éò„É´„Éó</span>
            <div className="dropdown-content">
              <div className="menu-option" onClick={() => window.open('https://docs.tova-ide.local', '_blank')}>
                <span>„Éâ„Ç≠„É•„É°„É≥„Éà</span>
                <span className="shortcut">F1</span>
              </div>
              <div className="menu-option" onClick={() => window.open('https://arduino.cc/reference', '_blank')}>
                <span>Arduino „É™„Éï„Ç°„É¨„É≥„Çπ</span>
              </div>
              <div className="menu-option" onClick={() => window.open('https://platformio.org/docs/', '_blank')}>
                <span>PlatformIO „Éâ„Ç≠„É•„É°„É≥„Éà</span>
              </div>
              <div className="menu-separator"></div>
              <div className="menu-option" onClick={() => window.open('https://github.com/tova-ide', '_blank')}>
                <span>GitHub</span>
              </div>
              <div className="menu-option" onClick={() => window.open('https://github.com/tova-ide/issues', '_blank')}>
                <span>„Éê„Ç∞„É¨„Éù„Éº„Éà</span>
              </div>
              <div className="menu-separator"></div>
              <div className="menu-option" onClick={() => handleMenuClick('about')}>
                <span>„Éê„Éº„Ç∏„Éß„É≥ÊÉÖÂ†±</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div className="title-bar-right">
        <span className="project-indicator">
          {currentProject?.name || '„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Å™„Åó'}
        </span>

        <button 
          className="title-btn log-btn" 
          onClick={() => setShowProgressLog(true)} 
          title="ÈÄ≤Êçó„É≠„Ç∞„ÇíË°®Á§∫"
        >
          üìã
        </button>

        <button 
          className="title-btn share-btn" 
          onClick={() => setShowLANShare(true)} 
          title="LANÂÜÖ„Éú„Éº„ÉâÂÖ±Êúâ"
        >
          üåê
        </button>

        <button className="title-btn theme-btn" onClick={toggleTheme} title="„ÉÜ„Éº„ÉûÂàá„ÇäÊõø„Åà">
          {theme === 'dark' ? 'Dark' : theme === 'light' ? 'Light' : 'Blue'}
        </button>
        
        <button 
          className="window-control minimize" 
          onClick={() => window.electronAPI?.window.minimize()}
          title="ÊúÄÂ∞èÂåñ"
        >
          _
        </button>
        <button 
          className="window-control maximize" 
          onClick={() => window.electronAPI?.window.maximize()}
          title="ÊúÄÂ§ßÂåñ"
        >
          []
        </button>
        <button 
          className="window-control close" 
          onClick={() => window.electronAPI?.window.close()}
          title="Èñâ„Åò„Çã"
        >
          X
        </button>
      </div>

      {/* Progress Log Modal */}
      <ProgressLog 
        isVisible={showProgressLog} 
        onClose={() => setShowProgressLog(false)} 
      />

      {/* LAN Share Manager Modal */}
      <LANShareManager 
        isVisible={showLANShare} 
        onClose={() => setShowLANShare(false)} 
      />
    </div>
  );
};

export default TitleBar;